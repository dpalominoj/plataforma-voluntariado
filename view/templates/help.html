{% extends "base.html" %}

{% set nav_bg = "bg-hr-ayuda" %}
{% set border_color = "border-cl-ayuda" %}
{% block title %}Ayuda y Soporte Interactivo{% endblock %}

{% block head_extra %}
{{ super() }}
<!-- Tailwind CSS classes will be applied directly to HTML elements. -->
<!-- Minimal custom styles for things not easily handled by Tailwind utilities like animations -->
<style>
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
    }
    .loading-dot {
        width: 0.5rem; /* w-2 */
        height: 0.5rem; /* h-2 */
        background-color: currentColor;
        border-radius: 9999px; /* rounded-full */
        animation: bounce 1s infinite;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.1s; }
    .loading-dot:nth-child(3) { animation-delay: 0.2s; }

    /* Custom scrollbar styling (optional, Tailwind doesn't directly control this well across browsers) */
    .chatbot-messages-area::-webkit-scrollbar {
        width: 8px;
    }
    .chatbot-messages-area::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; /* cool-gray-300 */
        border-radius: 4px;
    }
    .chatbot-messages-area::-webkit-scrollbar-track {
        background-color: #f1f5f9; /* cool-gray-100 */
    }
    /* For Firefox */
    .chatbot-messages-area {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }
</style>
{% endblock %}


{% block content %}
<div class="bg-gray-50 py-8 sm:py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl">
                Centro de Ayuda y Soporte
            </h1>
            <p class="mt-4 text-xl text-gray-600">
                Encuentra respuestas a tus preguntas, explora guías o chatea con nuestro asistente virtual.
            </p>
        </div>

        <!-- Example sections for a help page -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-150 ease-in-out">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3">Preguntas Frecuentes (FAQ)</h2>
                <p class="text-gray-600 mb-4">Encuentra respuestas rápidas a las preguntas más comunes sobre voluntariado, uso de la plataforma y más.</p>
                <a href="#" class="text-indigo-600 hover:text-indigo-800 font-medium">Explorar FAQ &rarr;</a>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-150 ease-in-out">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3">Guías y Tutoriales</h2>
                <p class="text-gray-600 mb-4">Aprende a sacar el máximo provecho de nuestra plataforma con guías paso a paso.</p>
                <a href="#" class="text-indigo-600 hover:text-indigo-800 font-medium">Ver Guías &rarr;</a>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">¿Necesitas Asistencia Personalizada?</h2>
            <p class="text-gray-600 mb-4">
                Nuestro asistente virtual está disponible 24/7 para ayudarte con tus consultas.
                También puedes contactar a nuestro equipo de soporte.
            </p>
            <button id="triggerChatbotButtonPage"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block mr-2 align-middle">
                    <path d="M4.913 2.658c2.075-.608 4.303.434 4.913 2.514l.248 1.07c.064.277.18.535.336.771l.495 1.026c.248.513.828.828 1.413.828h1.282c.585 0 1.165-.315 1.413-.828l.495-1.026c.156-.236.272-.494.336-.771l.248-1.07c.61-2.08 1.838-3.122 3.913-2.514C22.936 3.272 24 5.21 24 7.29v4.815A6.294 6.294 0 0 1 17.706 18.4H6.294A6.294 6.294 0 0 1 0 12.105V7.29c0-2.08.064-4.018 1.087-4.632Z" />
                    <path d="M12 14.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" />
                    <path fill-rule="evenodd" d="M3.06 19.222a2.251 2.251 0 0 1 2.168-.016l2.726-1.636a.751.751 0 0 0 .28-.542v-.683a4.497 4.497 0 0 1-.387-.595l-.743-1.114a.75.75 0 0 0-1.32.881l.743 1.114a3 3 0 0 0 .258.396v.283c0 .03-.004.06-.011.089l-2.726 1.636A2.25 2.25 0 0 1 3.06 19.222ZM20.94 19.222a2.251 2.251 0 0 0-2.168-.016l-2.726-1.636a.751.751 0 0 1-.28-.542v-.683c.112-.211.193-.43.258-.655l.743-1.114a.75.75 0 0 1 1.32.881l-.743 1.114a3.004 3.004 0 0 1-.387.596v.283c0 .03.004.06.011.089l2.726 1.636A2.25 2.25 0 0 0 20.94 19.222Z" clip-rule="evenodd" />
                </svg>
                Chatear con Asistente Virtual
            </button>
        </div>
    </div>
</div>

<!-- Chatbot Widget Button -->
<button id="chatbotToggleButton"
        class="fixed bottom-6 right-6 z-50 w-16 h-16 rounded-full shadow-lg bg-indigo-600 text-white flex items-center justify-center cursor-pointer hover:scale-110 transition-transform focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75"
        aria-label="Abrir chatbot">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-3.861 8.25-8.625 8.25S3.75 16.556 3.75 12 7.611 3.75 12.375 3.75s8.625 3.694 8.625 8.25z" />
    </svg>
</button>

<!-- Chatbot Panel -->
<div id="chatbotPanel"
     class="hidden fixed bottom-24 right-6 w-[350px] sm:w-96 h-[500px] max-h-[80vh] bg-white rounded-lg shadow-2xl border border-gray-200 z-40 flex flex-col overflow-hidden">
    <header class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 id="chatbotPanelTitle" class="text-lg font-semibold text-gray-800">¿Cómo prefieres obtener ayuda?</h3>
        <button id="closeChatbotButton" class="p-1 text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded" aria-label="Cerrar chatbot">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </header>

    <div class="p-4 flex-grow flex flex-col overflow-y-hidden">
        <!-- Mode Selection View -->
        <div id="chatbotSelectionMode" class="flex-1 flex flex-col justify-center space-y-3">
            <button id="openVoiceChatButton"
                    class="w-full p-4 rounded-md flex items-center justify-center space-x-2 text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
                <span>Chat por Voz</span>
            </button>
            <button id="openTextChatButton"
                    class="w-full p-4 rounded-md flex items-center justify-center space-x-2 text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5h10.5M6.75 10.5h10.5M6.75 13.5h10.5M21 12a9 9 0 11-18 0 9 9 0 0118 0Z" />
                </svg>
                <span>Chat de Texto</span>
            </button>
        </div>

        <!-- Chat View (Text/Voice) -->
        <div id="chatbotChatMode" class="hidden flex-1 flex flex-col h-full">
            <div id="chatMessages" class="chatbot-messages-area flex-grow overflow-y-auto mb-4 pr-2 space-y-3">
                <!-- Messages will be appended here by JavaScript -->
            </div>

            <div id="chatLoadingIndicator" class="hidden flex justify-start mb-3">
                 <div class="max-w-[80%] p-3 rounded-lg text-sm bg-gray-200 text-gray-700 flex space-x-1">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div id="chatApiError" class="text-red-500 text-xs text-center mb-2 hidden">Error: No se pudo conectar.</div>

            <div class="mt-auto"> {/* Pushes input area to bottom */}
                <div id="voiceInputControls" class="hidden text-center mb-2">
                    <button id="toggleVoiceRecordingButton"
                            class="w-12 h-12 rounded-full text-white flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors"
                            aria-label="Empezar a grabar voz">
                        <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                        </svg>
                        <svg id="micOffIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.82m5.84-2.56a6 6 0 01-2.63 5.18m2.63-5.18l-2.63-5.18M9.41 14.37A6 6 0 0015 18.75v-4.82M9.41 14.37l-2.63 5.18M9.41 14.37l2.63-5.18M12 18.75v-4.82M12 4.5v3.75m0 0A3.75 3.75 0 1015.75 12H12m0 0A3.75 3.75 0 118.25 12H12m0 0A3.75 3.75 0 1012 4.5V3m0 0a3.75 3.75 0 00-3.75 3.75M12 3c0 .966-.25 1.863-.688 2.625M12 3A3.75 3.75 0 0115.75 6.75m-3.75-.938c.438-.762.688-1.659.688-2.625m-3.75 0A3.75 3.75 0 008.25 6.75M5.625 12A3.75 3.75 0 009.375 15.75m0 0V12m0 0a3.75 3.75 0 013.75 3.75M12 12a3.75 3.75 0 003.75-3.75m-7.5 0A3.75 3.75 0 0112 8.25m0 0V12m0 0a3.75 3.75 0 013.75 3.75" />
                        </svg>
                    </button>
                    <p id="voiceRecordingStatus" class="text-xs text-gray-500 mt-1">Presiona para hablar</p>
                </div>

                <div class="flex space-x-2">
                    <input type="text" id="chatInput"
                           class="flex-1 p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none"
                           placeholder="Escribe tu mensaje...">
                    <button id="sendChatButton"
                            class="p-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-70 disabled:cursor-not-allowed transition-colors"
                            aria-label="Enviar mensaje">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </div>

                <div class="flex justify-between items-center mt-2">
                    <button id="backToSelectionButton" class="text-xs text-gray-500 hover:text-gray-700 p-1 focus:outline-none">← Volver</button>
                    <p class="text-xs text-gray-400">Asistente IA</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# {{ super() }} #}
{# The existing script imports are removed as we will consolidate into one script block or a new JS file for the chatbot in the next step #}
{# <script src="https://cdn.socket.io/4.5.2/socket.io.min.js"></script> #}
{# <script src="{{ url_for('static', filename='js/help_chat.js') }}" defer></script> #}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatbotToggleButton = document.getElementById('chatbotToggleButton');
    const triggerChatbotButtonPage = document.getElementById('triggerChatbotButtonPage');
    const chatbotPanel = document.getElementById('chatbotPanel');
    const closeChatbotButton = document.getElementById('closeChatbotButton');
    const chatbotPanelTitle = document.getElementById('chatbotPanelTitle');

    const chatbotSelectionMode = document.getElementById('chatbotSelectionMode');
    const chatbotChatMode = document.getElementById('chatbotChatMode');

    const openVoiceChatButton = document.getElementById('openVoiceChatButton');
    const openTextChatButton = document.getElementById('openTextChatButton');

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChatButton = document.getElementById('sendChatButton');
    const backToSelectionButton = document.getElementById('backToSelectionButton');

    const voiceInputControls = document.getElementById('voiceInputControls');
    const toggleVoiceRecordingButton = document.getElementById('toggleVoiceRecordingButton');
    const micIcon = document.getElementById('micIcon');
    const micOffIcon = document.getElementById('micOffIcon');
    const voiceRecordingStatus = document.getElementById('voiceRecordingStatus');

    const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');
    const chatApiError = document.getElementById('chatApiError');

    let currentMode = 'selection'; // 'selection', 'text', 'voice'
    let messages = [];
    let sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    let recognition = null;
    let isRecording = false;

    // Tailwind classes for dynamic styling
    const tailwindStyles = {
        buttons: {
            primary: ['bg-indigo-600', 'hover:bg-indigo-700', 'text-white', 'focus:ring-indigo-500'],
            secondary: ['bg-gray-200', 'hover:bg-gray-300', 'text-gray-700', 'focus:ring-gray-400'],
            destructive: ['bg-red-600', 'hover:bg-red-700', 'text-white', 'focus:ring-red-500']
        },
        messageBubbles: {
            user: ['bg-indigo-600', 'text-white'],
            bot: ['bg-gray-200', 'text-gray-800']
        },
        micButton: {
            idle: ['bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500'],
            recording: ['bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500']
        }
    };


    // --- UI Management ---
    function togglePanel(open) {
        if (open) {
            chatbotPanel.classList.remove('hidden');
            resetToSelectionMode(); // Start at selection mode when opened
        } else {
            chatbotPanel.classList.add('hidden');
            stopVoiceRecording(); // Ensure recording stops if panel is closed
        }
    }

    function setMode(mode) {
        currentMode = mode;
        chatApiError.classList.add('hidden'); // Hide errors on mode change

        chatbotSelectionMode.classList.add('hidden');
        chatbotChatMode.classList.add('hidden');
        voiceInputControls.classList.add('hidden');
        chatInput.classList.remove('hidden'); // Default to visible for text

        if (mode === 'selection') {
            chatbotPanelTitle.textContent = '¿Cómo prefieres obtener ayuda?';
            chatbotSelectionMode.classList.remove('hidden');
            messages = []; // Clear messages when going back to selection
            renderMessages();
        } else {
            chatbotChatMode.classList.remove('hidden');
            addMessage('bot', '¡Hola! Soy tu asistente virtual. ¿En qué puedo ayudarte hoy?');
            if (mode === 'text') {
                chatbotPanelTitle.textContent = 'Chat de Texto';
                chatInput.focus();
            } else if (mode === 'voice') {
                chatbotPanelTitle.textContent = 'Asistente de Voz';
                voiceInputControls.classList.remove('hidden');
                // chatInput.classList.add('hidden'); // Hide text input in voice mode
                initializeVoiceRecognition();
            }
        }
    }

    function resetToSelectionMode() {
        setMode('selection');
    }

    // --- Message Handling ---
    function addMessage(type, messageText, timestamp = new Date()) {
        const message = { type, message: messageText, timestamp };
        messages.push(message);
        renderMessages();
        scrollToBottom();
    }

    function renderMessages() {
        chatMessages.innerHTML = ''; // Clear existing messages
        messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', msg.type);

            const bubbleDiv = document.createElement('div');
            // Base bubble classes: 'max-w-[80%]', 'p-3', 'rounded-lg', 'text-sm', 'word-wrap-break-word' (Tailwind equivalent for word-wrap)
            bubbleDiv.classList.add('max-w-[80%]', 'p-3', 'rounded-lg', 'text-sm', 'break-words');

            if (msg.type === 'user') {
                messageDiv.classList.add('flex', 'justify-end');
                bubbleDiv.classList.add(...tailwindStyles.messageBubbles.user);
            } else {
                messageDiv.classList.add('flex', 'justify-start');
                bubbleDiv.classList.add(...tailwindStyles.messageBubbles.bot);
            }
            bubbleDiv.textContent = msg.message;

            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
        });
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function handleSendMessage(messageText, messageType = 'text') {
        if (!messageText.trim()) return;

        addMessage('user', messageText);
        if (messageType === 'text') {
            chatInput.value = '';
        }

        chatLoadingIndicator.classList.remove('hidden');
        sendChatButton.disabled = true;
        chatInput.disabled = true;
        chatApiError.classList.add('hidden');

        try {
            const response = await fetch('/api/chatbot/conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sessionId: sessionId,
                    userMessage: messageText,
                    messageType: messageType
                }),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: "Error sending message." }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            addMessage('bot', data.response);

        } catch (error) {
            console.error('Error sending message:', error);
            addMessage('bot', 'Lo siento, no pude procesar tu mensaje. Intenta de nuevo.');
            chatApiError.textContent = `Error: ${error.message}`;
            chatApiError.classList.remove('hidden');
        } finally {
            chatLoadingIndicator.classList.add('hidden');
            sendChatButton.disabled = false;
            chatInput.disabled = false;
            if (currentMode === 'text') chatInput.focus();
        }
    }

    // --- Voice Recognition ---
    function initializeVoiceRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceRecordingStatus.textContent = 'Reconocimiento de voz no soportado.';
            toggleVoiceRecordingButton.disabled = true;
            // Fallback or disable voice mode
            addMessage('bot', 'Tu navegador no soporta reconocimiento de voz. Por favor, usa el chat de texto.');
            // setMode('text'); // Optionally force back to text mode
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'es-ES'; // Spanish

        recognition.onstart = () => {
            isRecording = true;
            voiceRecordingStatus.textContent = 'Escuchando...';
            micIcon.classList.add('hidden');
            micOffIcon.classList.remove('hidden');
            toggleVoiceRecordingButton.classList.remove(...tailwindStyles.micButton.idle);
            toggleVoiceRecordingButton.classList.add(...tailwindStyles.micButton.recording);
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            handleSendMessage(transcript, 'voice');
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            let errorMessage = 'Error de reconocimiento.';
            if (event.error === 'no-speech') {
                errorMessage = 'No se detectó voz. Intenta de nuevo.';
            } else if (event.error === 'audio-capture') {
                errorMessage = 'Error de micrófono. Verifica los permisos.';
            } else if (event.error === 'not-allowed') {
                errorMessage = 'Permiso de micrófono denegado.';
            }
            voiceRecordingStatus.textContent = errorMessage;
            addMessage('bot', `Error de voz: ${errorMessage}`);
        };

        recognition.onend = () => {
            isRecording = false;
            voiceRecordingStatus.textContent = 'Presiona para hablar';
            micIcon.classList.remove('hidden');
            micOffIcon.classList.add('hidden');
            toggleVoiceRecordingButton.classList.remove(...tailwindStyles.micButton.recording);
            toggleVoiceRecordingButton.classList.add(...tailwindStyles.micButton.idle);
        };
    }

    function toggleVoiceRecording() {
        if (!recognition) {
            initializeVoiceRecognition();
            if (!recognition) return; // If still no recognition, exit
        }

        if (isRecording) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (e) {
                // This can happen if recognition is already active or other issues
                console.error("Error starting voice recognition:", e);
                voiceRecordingStatus.textContent = 'Error al iniciar grabación.';
                 isRecording = false; // Ensure state is correct
            }
        }
    }

    function stopVoiceRecording() {
        if (recognition && isRecording) {
            recognition.stop();
        }
    }

    // --- Event Listeners ---
    chatbotToggleButton.addEventListener('click', () => togglePanel(chatbotPanel.classList.contains('hidden')));
    if(triggerChatbotButtonPage) { // This button is on the page, not in the widget
        triggerChatbotButtonPage.addEventListener('click', () => togglePanel(true));
    }
    closeChatbotButton.addEventListener('click', () => togglePanel(false));

    openVoiceChatButton.addEventListener('click', () => setMode('voice'));
    openTextChatButton.addEventListener('click', () => setMode('text'));
    backToSelectionButton.addEventListener('click', resetToSelectionMode);

    sendChatButton.addEventListener('click', () => handleSendMessage(chatInput.value, 'text'));
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent newline in input
            handleSendMessage(chatInput.value, 'text');
        }
    });

    toggleVoiceRecordingButton.addEventListener('click', toggleVoiceRecording);

    // Initial state
    // togglePanel(false); // Keep it closed initially
    // setMode('selection'); // Set initial view inside panel for when it opens
});
</script>
{% endblock %}
